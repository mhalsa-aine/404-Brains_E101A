const apiKeyInput = document.getElementById('apiKeyInput');
const saveBtn = document.getElementById('saveBtn');
const deleteBtn = document.getElementById('deleteBtn');
const toggleBtn = document.getElementById('toggleBtn');
const backBtn = document.getElementById('backBtn');
const statusIndicator = document.getElementById('statusIndicator');
const successMsg = document.getElementById('successMsg');
const errorMsg = document.getElementById('errorMsg');

let isPasswordVisible = false;

console.log("âš™ï¸ Settings page loaded");

// Load existing API key when page opens
chrome.storage.sync.get(['groqApiKey'], (result) => {
  console.log("ğŸ“¦ Storage result:", result);
  
  if (result.groqApiKey) {
    console.log("âœ… Found existing API key");
    apiKeyInput.value = result.groqApiKey;
    deleteBtn.style.display = 'block';
    showStatus('success', 'âœ… API Key is configured');
  } else {
    console.log("âš ï¸ No API key found");
    showStatus('warning', 'âš ï¸ No API Key configured yet');
  }
});

// Toggle password visibility
toggleBtn.addEventListener('click', () => {
  console.log("ğŸ‘ï¸ Toggling visibility");
  isPasswordVisible = !isPasswordVisible;
  apiKeyInput.type = isPasswordVisible ? 'text' : 'password';
  toggleBtn.textContent = isPasswordVisible ? 'ğŸ™ˆ Hide Key' : 'ğŸ‘ï¸ Show Key';
});

// Save API key
saveBtn.addEventListener('click', () => {
  console.log("ğŸ’¾ Save button clicked");
  const apiKey = apiKeyInput.value.trim();
  
  console.log("ğŸ”‘ API Key length:", apiKey.length);
  console.log("ğŸ”‘ Starts with gsk_:", apiKey.startsWith('gsk_'));
  
  // Validate API key format
  if (!apiKey) {
    console.error("âŒ Empty API key");
    showError('Please enter an API key');
    return;
  }
  
  if (!apiKey.startsWith('gsk_')) {
    console.error("âŒ Invalid API key format");
    showError('API key must start with "gsk_"');
    return;
  }
  
  if (apiKey.length < 30) {
    console.error("âŒ API key too short");
    showError('API key appears to be too short');
    return;
  }

  console.log("âœ… Validation passed, saving to storage...");
  
  // Save to Chrome storage
  chrome.storage.sync.set({ groqApiKey: apiKey }, () => {
    if (chrome.runtime.lastError) {
      console.error("âŒ Storage error:", chrome.runtime.lastError);
      showError('Failed to save: ' + chrome.runtime.lastError.message);
      return;
    }
    
    console.log("âœ… API key saved successfully!");
    showSuccess('API Key saved successfully!');
    deleteBtn.style.display = 'block';
    showStatus('success', 'âœ… API Key is configured');
    
    // Auto-redirect back to chat after 1.5 seconds
    setTimeout(() => {
      console.log("â†©ï¸ Redirecting back to chat...");
      window.location.href = 'popup.html';
    }, 1500);
  });
});

// Delete API key
deleteBtn.addEventListener('click', () => {
  console.log("ğŸ—‘ï¸ Delete button clicked");
  
  if (confirm('Are you sure you want to delete your API key?')) {
    console.log("âœ… User confirmed deletion");
    
    chrome.storage.sync.remove(['groqApiKey'], () => {
      if (chrome.runtime.lastError) {
        console.error("âŒ Delete error:", chrome.runtime.lastError);
        showError('Failed to delete: ' + chrome.runtime.lastError.message);
        return;
      }
      
      console.log("âœ… API key deleted");
      apiKeyInput.value = '';
      deleteBtn.style.display = 'none';
      showSuccess('API Key deleted');
      showStatus('warning', 'âš ï¸ No API Key configured yet');
    });
  } else {
    console.log("âŒ User cancelled deletion");
  }
});

// Back button
backBtn.addEventListener('click', () => {
  console.log("â† Going back to chat");
  window.location.href = 'popup.html';
});

// Helper functions
function showStatus(type, message) {
  console.log(`ğŸ“Š Status: [${type}] ${message}`);
  statusIndicator.className = `status-indicator ${type}`;
  statusIndicator.innerHTML = `<span class="icon">${type === 'success' ? 'âœ…' : 'âš ï¸'}</span><span>${message}</span>`;
  statusIndicator.style.display = 'flex';
}

function showSuccess(message) {
  console.log("âœ… Success:", message);
  successMsg.textContent = 'âœ… ' + message;
  successMsg.style.display = 'block';
  errorMsg.style.display = 'none';
  setTimeout(() => {
    successMsg.style.display = 'none';
  }, 3000);
}

function showError(message) {
  console.error("âŒ Error:", message);
  errorMsg.textContent = 'âŒ ' + message;
  errorMsg.style.display = 'block';
  successMsg.style.display = 'none';
  setTimeout(() => {
    errorMsg.style.display = 'none';
  }, 3000);
}

// Enable save button when input changes
apiKeyInput.addEventListener('input', () => {
  saveBtn.disabled = !apiKeyInput.value.trim();
  console.log("âœï¸ Input changed, save button enabled:", !!apiKeyInput.value.trim());
});

console.log("âœ… Settings.js initialized");